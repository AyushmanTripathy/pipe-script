#! /usr/bin/env node 
globalThis.release_mode=!0;import{createInterface}from"readline";import{readFileSync,watchFile,existsSync,createReadStream}from"fs";function value(e,s){switch(typeof e){case"string":var r=checkType(checkForVars(e,s));return e.startsWith("-$")?-1*r:r;case"undefined":return error("detected undefined value");case"NaN":return error("detected NaN value");default:return e}}function checkType(e){return 0==e?0:Number(e)?Number(e):"true"==e||"false"!=e&&("null"==e?null:("string"!=typeof e||e.startsWith("%string")&&(e=e.split("%"),e=scopes[e[1]][e[2]]),e))}function checkForVars(e,s){return(e=e.startsWith("-$")?e.substring(1):e).startsWith("$")?(s.hasOwnProperty(e.substring(1))?s:scopes.vars)[e.substring(1)]:e}function checkArgs(e){const s=[],r=[];for(const t of e)t.startsWith("-")?s.push(t.substring(1)):r.push(t);return{options:s,words:r}}function stringify(e){return e.split(" ").join("[s]")}function str(e){return"string"!=typeof e?e:e=e.split("[s]").join(" ")}function hash(){return hash_code++,`@${hash_code}`}function last(e){return e[e.length-1]}function runGlobalScope(){var e=runScope(scopes.global,scopes.vars)["breaked"];e&&error("invalid break statment in global scope")}function runScope(e,s={}){if(!e)return error("invalid scope");for(var r of e=e.slice())if(r.startsWith("@")){var t=checkForKeyWords(r,s);if(t.returned||t.breaked)return t}else{if(r.startsWith("break"))return{breaked:!0};t=runLine(r,s);if(r.startsWith("return"))return{returned:!0,value:value(t,s)}}return{}}function checkForKeyWords(e,s){const r=globalThis.scopes[e][0];return r.startsWith("while")?whileLoop(e,s):r.startsWith("loop")?basicLoop(e,s):r.startsWith("if")?if_statement(e,s):r.startsWith("try")?try_block(e,s):r.startsWith("switch")?switch_block(e,s):(error(`invalid block ${r}`),{})}function runFunction(e,s){if(config.maximum_call_stack--,!config.maximum_call_stack)return error("maximum call stack exceded");if(!globalThis.scopes.hasOwnProperty(e))return error(`${e} is not a function`);const r=globalThis.scopes[e].slice();let t=r.shift().split(" ").filter(Boolean);t=t.splice(2);const o={};for(const c of t)o[c.substring(1)]=s.shift();var n=runScope(r,o);return n.breaked&&error(`invalid break statment in function ${e}`),n}function switch_block(e,s){const r=scopes[e];var t,o=runLine("pass_input "+r.shift().slice(6),s);let n={};for(let e=0;e<r.length;e++){if(r[e].startsWith("default")?(e++,n=runScope(scopes[r[e]],s)):r[e].startsWith("case")?(t=runLine("pass_input "+r[e].slice(4),s),e++,value(o,s)==value(t,s)&&(n=runScope(scopes[r[e]],s))):error(`invalid keyword ${r[e]} in switch block`),n.breaked)return{value:null};if(n.returned)return n}return{}}function try_block(e,r){const t=scopes[e].slice();let o;try{o=runScope(scopes[t[1]],r)}catch(e){let s=t[2].split(" ")[1];s&&setVar(s.substring(1),stringify(e),r),o=runScope(scopes[t[3]],r)}return o}function if_statement(e,s){const r=scopes[e].slice();let t;e=r.length/2;for(const o of new Array(e)){let e=r.shift();if(e+=" ",e.startsWith("if")){if(e="boolean "+e.slice(2,-1),runLine(e,s)){t=r.shift();break}}else if(e.startsWith("elseif")){if(e="boolean "+e.slice(6,-1),runLine(e,s)){t=r.shift();break}}else if(e.startsWith("else")){t=r.shift();break}r.shift()}return t?runScope(scopes[t],s):{}}function basicLoop(e,s){let r=scopes[e].slice();r=r.shift()+" ",r=runLine("number "+r.slice(4,-1).trim(),s);let t=config.max_loop_limit;for(;0<r;){var{breaked:o,returned:n,value:c}=runScope(scopes[e].slice(1),s);if(o)break;if(n)return{returned:n,value:c};if(r--,!t)return error("Maximum loop limit reached");t--}return{}}function whileLoop(e,s){let r=scopes[e].slice();r=r.shift()+" ",r="boolean"+r.slice(5,-1);let t=config.max_loop_limit;for(;runLine(r,s);){var{breaked:o,returned:n,value:c}=runScope(scopes[e].slice(1),s);if(o)break;if(n)return{returned:n,value:c};if(!t)return error("Maximum loop limit reached");t--}return{}}function runLine(e,s){let r="";for(var t of e=(e=checkForBlocks(e,s)).split(" | ").filter(Boolean).reverse())t=t.trim(),t+=` ${r}`,r=runStatement(t,s);return r}function checkForBlocks(e,s,r=[]){if(!e.includes("[")&&!e.includes("]"))return e;let t=0;for(const n of e){if("["==n)r.push(t);else if("]"==n){var o=r.pop();if((e=e.slice(0,o)+runLine(e.slice(o+1,t),s)+e.slice(t+1,e.length)).includes("]")){e=checkForBlocks(e,s,r);break}break}t++}return e}function runStatement(e,s){return runCommand(s,(e=e.split(" ").filter(Boolean)).shift(),e)}function runCommand(r,s,t){switch(s){case"break":return"break";case"return":case"pass_input":return t[0]}switch(s){case"exit":process.exit();case"random":return Math.random()}switch(s){case"log":return log(t.reduce((e,s)=>e+=str(value(s,r)),"")),null;case"add":let e=0;return t.some(e=>"number"!=typeof value(e,r))&&(e=""),t.reduce((e,s)=>e+value(s,r),e);case"multiply":return t.reduce((e,s)=>e*=value(s,r),1);case"divide":return t.reduce((e,s)=>e/=value(s,r),1)}const o=checkArg(t.shift(),s,r);switch(s){case"boolean":return Boolean(o);case"number":return Number(o);case"not":return!Boolean(o);case"call":const e=[];for(const c of t)e.push(value(c,r));return runFunction(o,e).value;case"round":return Math.round(o);case"floor":return Math.floor(o);case"new":return new_constructor(o,t)}var n=checkArg(t.shift(),s,r,[o]);switch(s){case"get":let e=value(o,r);return e?e.startsWith("%")?(e=e.split("%"),scopes[e[1]][e[2]][n]):error(`${o} is not a Array/Object`):error(`${o} is not a Array/Object`);case"set":return Number(o)||0==o?error(`expected Chars got Number ${o}`):(o.startsWith("%")?setValue(o,n,checkArg(t.shift(),s,r,[o,n])):setVar(o,n,r),null);case"pow":return sum=o,Math.pow(o,n);case"reminder":return o%n;case"eq":return o==n;case"gt":return o>n;case"lt":return o<n;case"ge":return o>=n;case"le":return o<=n}error(`invalid command or arg - ${s} with arg ${[o,n,...t]}`)}function new_constructor(e){var s=hash();switch(e){case"Object":return scopes.object[s]={},`%object%${s}`;case"Array":return scopes.array[s]=[],`%array%${s}`;default:return error(`${e} is not a constructor`)}}function setValue(e,s,r){"array"===(e=e.split("%").filter(Boolean))[0]&&(Number(s)||0==s||error(`expected index to be a number , got ${s}`)),scopes[e[0]][e[1]][s]=r}function setVar(e,s,r){r.hasOwnProperty(e)?r[e]=s:scopes.vars[e]=s}function checkArg(e,s,r,t=[]){return Number(e)||0==e?Number(e):void 0!==e?value(e,r):void error(`unknown command - ${s} with arg [${[e,...t]}]`)}async function classifyScopes(e,s){let r=["global"],t=0,o,n=!1,c=[],i=!1;for(var a of e){var u,l,p,h,f,d=checkDepth(a);if(a.includes("#")&&(a.includes("##")&&(n=!n),a=a.split("#")[0]),a=checkQuotes(a),a=a.trim(),!n&&a){if(a.startsWith("import "))await s(a.slice(6));else if(t==d)scopes[last(r)].push(a);else if(t>d){for(const b of Array(t-d))r.pop();scopes[last(r)].push(a)}else t<d&&(o.startsWith("function")?(scopes[last(r)].pop(),l=(l=o.split(" ").filter(Boolean))[1],scopes[l]=[o,a],r.push(l)):o.startsWith("if")?(u=hash(),scopes[last(r)].pop(),scopes[last(r)].push(u),l=hash(),scopes[l]=[a],r.push(l),c.push(u),scopes[u]=[o,l]):o.startsWith("else")?(c.length||error(`invalid if block\n${o}\n${a}`,!0),scopes[last(r)].pop(),p=hash(),r.push(p),scopes[p]=[a],scopes[last(c)].push(o,p),o.startsWith("elseif")||c.pop()):o.startsWith("while")||o.startsWith("loop")?(p=hash(),scopes[last(r)].pop(),scopes[last(r)].push(p),scopes[p]=[o,a],r.push(p)):o.startsWith("try")?(i=hash(),h=hash(),scopes[last(r)].pop(),scopes[last(r)].push(i),scopes[h]=[a],scopes[i]=[o,h],r.push(h)):o.startsWith("catch")?(i||error(`try block not found \n ${o}\n${a}`,!0),h=hash(),scopes[i].push(o,h),scopes[last(r)].pop(),scopes[h]=[a],r.pop(),r.push(h),i=null):o.startsWith("switch")?(f=hash(),scopes[last(r)].pop(),scopes[last(r)].push(f),scopes[f]=[o,a],r.push(f)):o.startsWith("default")||o.startsWith("case")?(f=hash(),scopes[f]=[a],scopes[last(r)].push(f),r.push(f)):error(`invalid scope change\n${o}\n${a}`,!0));t=d,o=a}}}function checkQuotes(e){let s=0,r=!1,t=0;for(const c of e){if("'"==c){if(r){var o=hash(),n=e.slice(0,s);return n+=`%string%${o}`,n+=e.slice(t+1,e.length),scopes.string[o]=stringify(e.slice(s+1,t)),checkQuotes(n)}s=t,r=!r}t++}return e}function checkDepth(e){return("\t"==config.tab?checkTab:checkSpace)(e)}function checkSpace(e){let s=0;for(;e.startsWith(" ");)s++,e=e.substring(1);return Math.floor(s/config.tab)}function checkTab(e){let s=0;for(;e.startsWith("\t");)s++,e=e.substring(1);return console.log(s),s}const{options,words}=checkArgs(process.argv.splice(2)),cwd=process.cwd();function loadJson(e){e=readFileSync(new URL(e,import.meta.url));return JSON.parse(e)}function init(){for(const e of options)if("w"===e)return watchPath(words.shift());run([`import ${words.shift()}`])}async function watchPath(e){log(`WATCHING ${e}...`);const s={...config};watchFile(e,{},async()=>{log(`detected change on ${e}`),await run([`import ${e}`]),config=s})}async function run(e){globalThis.scopes={},globalThis.hash_code=0,scopes.global=[],scopes.vars={},scopes.object={},scopes.array={},scopes.string={};try{await classifyScopes(e,importFile),runGlobalScope()}catch(e){console.log(e),console.log("FATAL ERROR - terminating program...")}"undefined"==typeof release_mode&&console.log(scopes)}async function importFile(e){e=cwd+"/"+e.trim();if(!existsSync(e))return error(`path: ${e} doesnot exist`);e=createReadStream(e);const s=[];for await(const r of createInterface({input:e}))s.push(r);await classifyScopes(s,importFile)}globalThis.config=loadJson("../config.json"),globalThis.log=e=>{console.log(e)},globalThis.error=(e,s)=>{if(!s)throw`[RUNTIME ERROR] ${e}`;throw`[SYNTAX ERROR] ${e}`},init();
