#! /usr/bin/env node 
globalThis.release_mode=!0;import{createInterface}from"readline";import{readFileSync,writeFileSync,existsSync,createReadStream}from"fs";function hash(){return hash_code++,`@${hash_code}`}function last(e){return e[e.length-1]}async function classifyScopes(e,s){let t=["global"],o=0,i,c=null,r=!1;for(var n of e){var l,a,p,h=checkDepth(n);if(n.includes("#")&&(n.includes("##")&&(r=!r),n=n.split("#")[0]),n=checkQuotes(n),n=n.trim(),!r&&n){if(n.startsWith("import "))await s(n.slice(6));else if(o==h)scopes[last(t)].push(n);else if(o>h){for(const u of Array(o-h))t.pop();scopes[last(t)].push(n)}else o<h&&(i.startsWith("function")?(scopes[last(t)].pop(),a=(a=i.split(" ").filter(Boolean))[1],scopes[a]=[i,n],t.push(a)):i.startsWith("if")?(l=hash(),scopes[last(t)].pop(),scopes[last(t)].push(`${l}`),a=hash(),scopes[a]=[n],t.push(a),c=l,scopes[l]=[i,a]):i.startsWith("else")?(c||error(`invalid if statment - ${i}`),scopes[last(t)].pop(),p=hash(),t.push(p),scopes[p]=[n],scopes[c].push(i,p),i.startsWith("elseif")||(c=null)):i.startsWith("while")||i.startsWith("loop")?(p=hash(),scopes[last(t)].pop(),scopes[last(t)].push(`${p}`),scopes[p]=[i,n],t.push(p)):error(`invalid scope change\n${i}\n  ${n}`));o=h,i=n}}}function checkQuotes(e){let s=0,t=!1,o=0;for(const r of e){if("'"==r){if(t){var i=hash(),c=e.slice(0,s);return c+=`%string%${i}`,c+=e.slice(o+1,e.length),scopes.string[i]=e.slice(s+1,o).split(" ").join("[s]"),checkQuotes(c)}s=o,t=!t}o++}return e}function checkDepth(e){let s=0;for(;e.startsWith(" ");)s++,e=e.substring(1);return Math.floor(s/config.tab)}function compileGlobalScope(){globalThis.file="",globalThis.var_list=[],compileScope(scopes.global),log("---"),log(file),log("---")}function compileScope(e){for(var s of e=e.slice())s.startsWith("@")?checkForKeyWords(s):write(compileLine(s))}function checkForKeyWords(e){const s=globalThis.scopes[e][0];return s.startsWith("while")?whileLoop(e):s.startsWith("loop")?basicLoop(e):s.startsWith("if")?if_statement(e):void 0}function write(e){file+=e+"\n"}function if_statement(e){var s=scopes[e];for(let e=0;e<s.length;e++)write(check_if_block(s[e])),e++,compileScope(scopes[s[e]]),write("}")}function check_if_block(e){return e.startsWith("if")?"if("+compileLine(e.slice(2))+"){":e.startsWith("elseif")?"else if("+compileLine(e.slice(6))+"){":e.startsWith("else")?"else{":void 0}function basicLoop(e){const s=globalThis.scopes[e];var t=compileLine("number "+s.shift().slice(4));write(`let ${e="var"+hash().substring(1)} = ${t}`),write(`while(${e} != 0) {`),write(`${e} -= 1`),compileScope(s),write("}")}function whileLoop(e){const s=globalThis.scopes[e];write(`while(${compileLine(s.shift().slice(5))}) {`),compileScope(s),write("}")}function call_function(e,s){globalThis.scopes[e]||error(`${e} is not a function`);const t=globalThis.scopes[e];let o=t.shift().split(" ");return o=o.splice(2).map(checkToken),write(`function ${e} (${o.toString()}){`),compileScope(t),write("}"),`${e}(${s=s.map(checkToken)})`}function compileLine(e){let s="";for(const t of e=e.split(" | ").filter(Boolean).reverse())s=compileStatments(t+" "+s);return s}function compileStatments(e){return compileCommand(e=e.split(" ").filter(Boolean))}function compileCommand(e){var s=checkToken(e.shift());if("break"===s)return"break";switch(s){case"log":return`console.log(${e=e.reduce((e,s)=>e+checkToken(s,!0)+",","")})`;case"add":return e.reduce((e,s)=>e+checkToken(s)+"+","").slice(0,-1)}var t=checkToken(e.shift());switch(s){case"number":return`Number(${t})`;case"boolean":return`Boolean(${t})`;case"call":return call_function(t,e);case"return":return`return ${t}`}var o=checkToken(e.shift());switch(s){case"set":return setVar(t,o);case"eq":return`${t} == ${o}`;case"gt":return`${t} > ${o}`;case"lt":return`${t} < ${o}`;case"ge":return`${t} >= ${o}`;case"le":return`${t} <= ${o}`}}function setVar(e,s){return var_list.includes(e)?`${e} = ${s}`:(s=checkString(s),var_list.push(e),`let ${e} = ${s}`)}function checkString(e){return Number(e)||0==e?e:"null"==e?"null":`"${e}"`}function checkToken(e,s){return void 0===e?error("undefined token found"):e.startsWith("$")?e.substring(1):s?checkString(e):e}const args=process.argv.splice(2),cwd=process.cwd();function loadJson(e){e=readFileSync(new URL(e,import.meta.url));return JSON.parse(e)}function init(){run([`import ${args.shift()}`])}async function run(e){globalThis.scopes={},globalThis.hash_code=0,scopes.global=[],await classifyScopes(e,importFile),compileGlobalScope(scopes.global),"undefined"==typeof release_mode&&console.log(scopes),writeFileSync("test.js",globalThis.file)}async function importFile(e){e=cwd+"/"+e.trim();if(!existsSync(e))return error(`path: ${e} doesnot exist`);e=createReadStream(e);const s=[];for await(const t of createInterface({input:e}))s.push(t);await classifyScopes(s,importFile)}globalThis.config=loadJson("../config.json"),globalThis.log=e=>{console.log(e)},globalThis.error=e=>{console.log(`[ERROR] ${e}`),process.exit()},init();
